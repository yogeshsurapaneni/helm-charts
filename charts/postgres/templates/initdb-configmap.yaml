apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "postgres-shared.fullname" . }}-initdb
data:
  init-multiple-dbs.sh: |
    #!/bin/bash
    set -e
    echo "Ensuring multiple databases exist..."
    for db in {{ join " " .Values.databases }}; do
      echo "Checking database: $db"
      psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
        DO \$\$
        BEGIN
          IF NOT EXISTS (SELECT FROM pg_database WHERE datname = '$db') THEN
            RAISE NOTICE 'Creating database $db...';
            CREATE DATABASE "$db";
            GRANT ALL PRIVILEGES ON DATABASE "$db" TO "$POSTGRES_USER";
          ELSE
            RAISE NOTICE 'Database $db already exists, skipping.';
          END IF;
        END
        \$\$;
      EOSQL
    done
    echo "All databases ensured successfully."
